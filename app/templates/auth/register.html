{% extends "base.html" %}

{% block title %}Register{% endblock %}

{% block main_class %}main-content--full{% endblock %}

{% block content %}
<div style="min-height: calc(100vh - var(--navbar-height) - 200px); display: flex; align-items: center; justify-content: center; padding: 32px 16px;">
    <div class="card" style="max-width: 440px; width: 100%; padding: 40px;">
        
        <div style="text-align: center; margin-bottom: 32px;">
            <div style="width: 56px; height: 56px; background: var(--accent); border-radius: var(--radius-md);
                        display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;
                        font-size: 28px; color: white;">
                ✨
            </div>
            <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Create account</h1>
            <p style="color: var(--text-muted); font-size: 14px;">Start shortening links for free</p>
        </div>

        <form id="registerForm" onsubmit="handleRegister(event)">
            <div style="margin-bottom: 20px;">
                <label class="input-label" for="username">Username</label>
                <input type="text" id="username" class="input" placeholder="johndoe" required 
                       pattern="[a-zA-Z0-9_]{3,30}" title="3-30 characters, letters, digits, underscore">
            </div>

            <div style="margin-bottom: 20px;">
                <label class="input-label" for="email">Email</label>
                <input type="email" id="email" class="input" placeholder="your@email.com" required>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="input-label" for="password">Password</label>
                <input type="password" id="password" class="input" placeholder="••••••••" required
                       minlength="8" oninput="checkPasswordStrength()">
                <div id="passwordStrength" style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                    Must be at least 8 characters with uppercase and digit
                </div>
            </div>

            <button type="submit" class="btn btn--primary" style="width: 100%; padding: 14px;" id="submitBtn">
                <span id="btnText">Create Account</span>
                <span id="btnSpinner" style="display: none;">⏳</span>
            </button>
        </form>

        <div style="text-align: center; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-default);">
            <p style="font-size: 14px; color: var(--text-muted);">
                Already have an account?
                <a href="/login" style="font-weight: 600;">Log in →</a>
            </p>
        </div>

    </div>
</div>

<script>
function checkPasswordStrength() {
    const password = document.getElementById('password').value;
    const strengthDiv = document.getElementById('passwordStrength');
    
    let strength = 0;
    if (password.length >= 8) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    const labels = ['Weak', 'Fair', 'Good', 'Strong'];
    const colors = ['var(--error)', 'var(--warning)', 'var(--info)', 'var(--success)'];
    
    if (password.length > 0) {
        strengthDiv.textContent = `Password strength: ${labels[strength - 1] || 'Weak'}`;
        strengthDiv.style.color = colors[strength - 1] || colors[0];
    } else {
        strengthDiv.textContent = 'Must be at least 8 characters with uppercase and digit';
        strengthDiv.style.color = 'var(--text-muted)';
    }
}

async function handleRegister(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnSpinner.style.display = 'inline';
    
    const data = {
        username: document.getElementById('username').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
    };
    
    try {
        const response = await fetch('/api/v1/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        
        if (response.ok) {
            Toast.show('Account created successfully!', 'success');
            setTimeout(() => window.location.href = '/dashboard', 500);
        } else {
            const error = await response.json();
            Toast.show(error.detail || 'Registration failed', 'error');
            submitBtn.disabled = false;
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
        }
    } catch (error) {
        Toast.show('Network error', 'error');
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnSpinner.style.display = 'none';
    }
}
</script>
{% endblock %}
